# Server Service - Web crawling and document processing microservice

# Build stage
FROM python:3.11 AS builder

WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy and install Python dependencies
COPY requirements.server.txt .
RUN pip install --user --no-cache-dir -r requirements.server.txt

# Runtime stage
FROM python:3.11-slim

WORKDIR /app

# Install runtime dependencies for Playwright, Redis, supervisor, and Node.js for Gemini CLI
RUN apt-get update && apt-get install -y \
    wget \
    ca-certificates \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    redis-server \
    supervisor \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libwayland-client0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    xdg-utils \
    redis-server \
    supervisor \
    curl \
    gnupg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install Node.js 20 for Gemini CLI
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install Gemini CLI globally
RUN npm install -g @google/gemini-cli

# Configure Redis
RUN mkdir -p /var/lib/redis /var/log/redis /var/log/supervisor /etc/supervisor/conf.d && \
    chown -R redis:redis /var/lib/redis /var/log/redis && \
    sed -i 's/^bind .*/bind 127.0.0.1/' /etc/redis/redis.conf && \
    sed -i 's/^protected-mode yes/protected-mode no/' /etc/redis/redis.conf && \
    sed -i 's/^# maxmemory <bytes>/maxmemory 256mb/' /etc/redis/redis.conf && \
    sed -i 's/^# maxmemory-policy noeviction/maxmemory-policy allkeys-lru/' /etc/redis/redis.conf

# Copy Python packages from builder
COPY --from=builder /root/.local /root/.local

# Install Playwright browsers
ENV PATH=/root/.local/bin:$PATH
RUN playwright install chromium

# Install neo4j package separately with explicit timeout and retries
RUN pip install --no-cache-dir --timeout=120 neo4j>=5.15.0 pytz || \
    pip install --no-cache-dir --timeout=120 neo4j>=5.15.0 pytz || \
    pip install --no-cache-dir --timeout=120 neo4j>=5.15.0 pytz

# Install SQLAlchemy for workflow models
RUN pip install --no-cache-dir --timeout=60 sqlalchemy>=2.0.0

# Copy MANIFEST.md (REQUIRED for Archon operation)
COPY MANIFEST.md /app/MANIFEST.md

# Copy configuration files and entrypoint
COPY redis.conf /etc/redis/redis.conf
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Create necessary directories and set permissions
# Note: redis user already exists from redis-server package installation
RUN mkdir -p /var/log/supervisor /var/log/redis /var/run/redis /var/lib/redis && \
    chown redis:redis /var/log/redis /var/run/redis /var/lib/redis

# Copy application code - force cache invalidation for updated imports (v2)
# This fixes the rag_service.py import issue by ensuring latest source code
COPY tests/ tests/
COPY src/ src/

# Set environment variables
ENV PYTHONPATH="/app:/root/.local/lib/python3.11/site-packages:$PYTHONPATH"
ENV PYTHONUNBUFFERED=1
ENV BUILD_DATE="2025-09-22-fix-imports"

# Expose Server port
ARG ARCHON_SERVER_PORT=8181
ENV ARCHON_SERVER_PORT=${ARCHON_SERVER_PORT}
EXPOSE ${ARCHON_SERVER_PORT}

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD sh -c "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:${ARCHON_SERVER_PORT}/health')\""

# Run the server directly (neo4j is now installed in the image)
CMD python -m uvicorn src.server.main:socket_app --host 0.0.0.0 --port ${ARCHON_SERVER_PORT:-8181} --workers 1